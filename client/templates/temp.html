<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebSocket Demo (Canvas)</title>
</head>
<body>
  <h1>WebSocket Client (Canvas Plot)</h1>
  <!-- Manually sized canvas for drawing frequency (x) vs power (y) -->
  <canvas id="frequencyCanvas" width="800" height="400" style="border:1px solid #ccc;"></canvas>
  <script>
    // Basic parameters
    const SAMPLE_RATE = 1.024e6;

    // Access the canvas and its 2D rendering context
    const canvas = document.getElementById('frequencyCanvas');
    const ctx = canvas.getContext('2d');

    // Open the WebSocket
    const ws = new WebSocket("/hi");

    ws.onopen = () => {
      console.log("WebSocket connected");
    };

    ws.onmessage = (event) => {
      // Parse incoming data as an ArrayBuffer of float32 samples
      event.data.arrayBuffer().then(buffer => {
        const floatData = new Float32Array(buffer);
        const n = floatData.length;

        // Build frequency axis so 0 Hz is centered
        const freqAxis = new Array(n);
        for (let i = 0; i < n; i++) {
          freqAxis[i] = ((i - n / 2) * SAMPLE_RATE) / n;
        }

        // Find min/max for frequency and dB range
        let freqMin = freqAxis[0];
        let freqMax = freqAxis[0];
        let dbMin = floatData[0];
        let dbMax = floatData[0];

        for (let i = 1; i < n; i++) {
          if (freqAxis[i] < freqMin) freqMin = freqAxis[i];
          if (freqAxis[i] > freqMax) freqMax = freqAxis[i];
          if (floatData[i] < dbMin) dbMin = floatData[i];
          if (floatData[i] > dbMax) dbMax = floatData[i];
        }

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw vertical bars
        ctx.fillStyle = '#0080ff';
        for (let i = 0; i < n; i++) {
          // Map freqAxis[i] from [freqMin, freqMax] to [0, canvas.width]
          const x = (freqAxis[i] - freqMin) / (freqMax - freqMin) * canvas.width;
          // Invert y so higher dB is higher on the canvas
          const y = canvas.height - (floatData[i] - dbMin) / (dbMax - dbMin) * canvas.height;

          // Draw a vertical bar from the dot to the bottom of the canvas
          ctx.fillRect(x, y, 1, canvas.height - y);
        }
      });
    };

    ws.onclose = () => {
      console.log("WebSocket disconnected");
    };
  </script>
</body>
</html>
